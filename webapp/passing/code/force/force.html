<!DOCTYPE html>
<html>
  <head>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js'></script>
    <style>
      circle.node {
        stroke: #fff;
        stroke-width: 1.5px;
      }

      line.link {
        stroke: #999;
        stroke-opacity: .6;
      }

      .node text {
        font: 9px helvetica;
      }
    </style>
  </head>
  <body>
    <div id='chart'></div>
    <script type='text/javascript'>
      // Big thanks to http://www.coppelia.io/2014/07/an-a-to-z-of-extra-features-for-the-d3-force-layout/ for guiding me through visualization improvements

      var w = 800,
          h = 500,
          fill = d3.scale.category20();

      var vis = d3.select('#chart')
        .append('svg:svg')
          .attr('width', w)
          .attr('height', h);

      d3.json('force.json', function(graph) {
        var visibleLinks = [];
        graph.nodes.forEach(function (n) {
          n.group = 0;
        });

        var force = d3.layout.force()
            .charge(-120)
            .linkDistance(250)
            .nodes(graph.nodes)
            .links(graph.links)
            .size([w, h])
            .start();

        var link = vis.selectAll('line.link')
            .data(visibleLinks)
          .enter().append('svg:line')
            .attr('class', 'link')
            .style('stroke-width', 1)
            .style("marker-end",  "url(#suit)");

        var node = vis.selectAll('.node')
          .data(graph.nodes)
          .enter().append('g')
          .attr('class', 'node')
          .call(force.drag);

        node.append('circle')
          .attr('r', 10)
          .attr('cx', function(d) { return d.x; })
          .attr('cy', function(d) { return d.y; });

        node.append('text')
          .attr('dx', 10)
          .attr('dy', '.35em')
          .text(function(d) { return d.id });

        vis.style('opacity', 1e-6)
          .transition()
            .duration(1000)
            .style('opacity', 1);

        vis.append("defs").selectAll("marker")
          .data(["suit"])
        .enter().append("marker")
          .attr("id", function(d) { return d; })
          .attr("viewBox", "0 -5 10 10")
          .attr("refX", 25)
          .attr("refY", 0)
          .attr("markerWidth", 6)
          .attr("markerHeight", 6)
          .attr("orient", "auto")
        .append("path")
          .attr("d", "M0,-5L10,0L0,5 L10,0 L0, -5")
          .style("stroke", "#4679BD")
          .style("opacity", "0.6");

        force.on('tick', function() {
          link.attr('x1', function(d) { return d.source.x; })
              .attr('y1', function(d) { return d.source.y; })
              .attr('x2', function(d) { return d.target.x; })
              .attr('y2', function(d) { return d.target.y; });

          d3.selectAll('circle')
            .attr('cx', function (d) {
              return d.x;
            })
            .attr('cy', function (d) {
              return d.y;
            })
            .style('fill', function (d) {
              if (d.group === 0) {
                return 'rgb(31, 119, 180)';
              }
              else {
                return 'rgb(255, 127, 14)'
              }
            });

          d3.selectAll('text')
            .attr('x', function (d) {
              return d.x;
            })
            .attr('y', function (d) {
              return d.y;
            });
        });

        function sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function runSimulation() {
          var source = 0;
          visibleLinks = [];
          
          graph.nodes.forEach(function (n) {
              if (n.index === source) {
                n.group = 1;
              }
              else {
                n.group = 0;
              }
            });
          restart();
          
          while (source != 5) {
            await sleep(1500);
            var potentialLinks = graph.links.filter(function (d) {
              return d.source.index === source;
            });
            var linkProbs = potentialLinks.map(function (l) {
              return l.label;
            });
            rnd = Math.random();
            idx = linkProbs.findIndex( a => (rnd -= a) < 0 );
            visibleLinks.push(potentialLinks[idx]);
            source = potentialLinks[idx].target.index;
            graph.nodes.forEach(function (n) {
              if (n.index === source) {
                n.group = 1;
              }
            });
            restart();
          }
        }

        //Restart the visualisation after any node and link changes
        function restart() {
          link = link.data(visibleLinks);
          link.exit().remove();
          link.enter().insert("svg:line", ".node").attr("class", "link").style("marker-end",  "url(#suit)");
          node = node.data(graph.nodes);
          node.exit().remove();
          node.enter().insert("circle", ".cursor")
            .attr("r", 10)
            .call(force.drag);
          force.start();
        }

        d3.select('#chart')
          .append('button')
          .attr('type', 'button')
          .text('Simulate Possession')
          .on('click', runSimulation);
      });
    </script>
  </body>
</ht